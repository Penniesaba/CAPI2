{% extends "base.html" %}

{% block title %}哈希算法 - 密码算法实现平台{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <h1><i class="fas fa-hashtag me-2"></i>哈希算法</h1>
        <p class="lead">哈希算法将任意长度的数据映射为固定长度的散列值，具有单向性和抗碰撞性。</p>
    </div>
</div>

<!-- 算法选择标签页 -->
<ul class="nav nav-pills mb-4" id="hashTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="hash-tab" data-bs-toggle="pill" data-bs-target="#hash" type="button" role="tab" aria-controls="hash" aria-selected="true">
            <i class="fas fa-hashtag me-1"></i>基本哈希函数
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="hmac-tab" data-bs-toggle="pill" data-bs-target="#hmac" type="button" role="tab" aria-controls="hmac" aria-selected="false">
            <i class="fas fa-signature me-1"></i>HMAC
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="pbkdf2-tab" data-bs-toggle="pill" data-bs-target="#pbkdf2" type="button" role="tab" aria-controls="pbkdf2" aria-selected="false">
            <i class="fas fa-key me-1"></i>PBKDF2
        </button>
    </li>
</ul>

<!-- 标签页内容 -->
<div class="tab-content" id="hashTabsContent">
    <!-- 基本哈希函数标签页 -->
    <div class="tab-pane fade show active" id="hash" role="tabpanel" aria-labelledby="hash-tab">
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-hashtag me-2"></i>基本哈希函数</h5>
            </div>
            <div class="card-body">
                <div class="algorithm-theory">
                    <h5><i class="fas fa-info-circle me-2"></i>哈希函数原理</h5>
                    <p>哈希函数将任意长度的数据映射为固定长度的散列值。理想的哈希函数具有以下特性：</p>
                    <ul>
                        <li><strong>单向性</strong>：从散列值计算原始数据在计算上是不可行的</li>
                        <li><strong>确定性</strong>：相同的输入总是产生相同的散列值</li>
                        <li><strong>雪崩效应</strong>：输入的微小变化会导致散列值的显著变化</li>
                        <li><strong>抗碰撞性</strong>：找到产生相同散列值的两个不同输入在计算上是困难的</li>
                    </ul>
                </div>
                
                <div class="row">
                    <div class="col-md-8">
                        <form id="hashForm">
                            <div class="mb-3">
                                <label for="hashMessage" class="form-label">输入消息</label>
                                <textarea class="form-control" id="hashMessage" rows="3" placeholder="输入要计算哈希值的消息"></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="hashAlgorithm" class="form-label">选择哈希算法</label>
                                <select class="form-select" id="hashAlgorithm">
                                    <option value="sha1">SHA1 (160位)</option>
                                    <option value="sha256" selected>SHA256 (256位)</option>
                                    <option value="sha3_256">SHA3-256 (256位)</option>
                                    <option value="sha3_512">SHA3-512 (512位)</option>
                                    <option value="ripemd160">RIPEMD160 (160位)</option>
                                </select>
                            </div>
                            <button type="button" id="calculateHashBtn" class="btn btn-success">
                                <i class="fas fa-hashtag me-1"></i> 计算哈希值
                            </button>
                        </form>
                        <div class="result-area mt-3" id="hashResult" style="display:none;"></div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">哈希算法比较</div>
                            <div class="card-body">
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item">
                                        <strong>SHA1</strong>: 160位，现已不推荐用于安全场景
                                    </li>
                                    <li class="list-group-item">
                                        <strong>SHA256</strong>: 256位，目前最广泛使用的哈希算法
                                    </li>
                                    <li class="list-group-item">
                                        <strong>SHA3</strong>: 新一代哈希算法，安全性更高
                                    </li>
                                    <li class="list-group-item">
                                        <strong>RIPEMD160</strong>: 160位，常用于区块链等应用
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- HMAC标签页 -->
    <div class="tab-pane fade" id="hmac" role="tabpanel" aria-labelledby="hmac-tab">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-signature me-2"></i>HMAC (哈希消息认证码)</h5>
            </div>
            <div class="card-body">
                <div class="algorithm-theory">
                    <h5><i class="fas fa-info-circle me-2"></i>HMAC原理</h5>
                    <p>HMAC (Hash-based Message Authentication Code) 是一种基于哈希函数的消息认证码，同时兼顾了消息完整性和身份认证功能。</p>
                    <p>HMAC = Hash((Key ⊕ opad) || Hash((Key ⊕ ipad) || Message))</p>
                    <ul>
                        <li><strong>密钥</strong>：用于计算HMAC的密钥</li>
                        <li><strong>消息</strong>：待验证的数据</li>
                        <li><strong>opad, ipad</strong>：两个不同常量，用于增强安全性</li>
                    </ul>
                </div>
                
                <div class="row">
                    <div class="col-md-8">
                        <form id="hmacForm">
                            <div class="mb-3">
                                <label for="hmacMessage" class="form-label">输入消息</label>
                                <textarea class="form-control" id="hmacMessage" rows="3" placeholder="输入要计算HMAC的消息"></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="hmacKey" class="form-label">密钥</label>
                                <input type="text" class="form-control" id="hmacKey" placeholder="输入HMAC密钥">
                                <div class="form-text">
                                    <button type="button" id="generateHmacKey" class="btn btn-sm btn-outline-secondary mt-1">
                                        生成随机密钥
                                    </button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="hmacAlgorithm" class="form-label">选择哈希算法</label>
                                <select class="form-select" id="hmacAlgorithm">
                                    <option value="hmac_sha1">HMAC-SHA1</option>
                                    <option value="hmac_sha256" selected>HMAC-SHA256</option>
                                </select>
                            </div>
                            <button type="button" id="calculateHmacBtn" class="btn btn-primary">
                                <i class="fas fa-signature me-1"></i> 计算HMAC
                            </button>
                        </form>
                        <div class="result-area mt-3" id="hmacResult" style="display:none;"></div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">HMAC应用场景</div>
                            <div class="card-body">
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item">
                                        <i class="fas fa-check-circle text-success me-2"></i>消息完整性验证
                                    </li>
                                    <li class="list-group-item">
                                        <i class="fas fa-check-circle text-success me-2"></i>API身份认证
                                    </li>
                                    <li class="list-group-item">
                                        <i class="fas fa-check-circle text-success me-2"></i>会话令牌验证
                                    </li>
                                    <li class="list-group-item">
                                        <i class="fas fa-check-circle text-success me-2"></i>数字签名生成前处理
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- PBKDF2标签页 -->
    <div class="tab-pane fade" id="pbkdf2" role="tabpanel" aria-labelledby="pbkdf2-tab">
        <div class="card mb-4">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0"><i class="fas fa-key me-2"></i>PBKDF2 (密钥派生函数)</h5>
            </div>
            <div class="card-body">
                <div class="algorithm-theory">
                    <h5><i class="fas fa-info-circle me-2"></i>PBKDF2原理</h5>
                    <p>PBKDF2 (Password-Based Key Derivation Function 2) 是一种用于从密码中派生密钥的函数，它使用以下参数：</p>
                    <ul>
                        <li><strong>密码</strong>：原始密码或口令</li>
                        <li><strong>盐值</strong>：随机生成的值，用于防止预计算攻击</li>
                        <li><strong>迭代次数</strong>：重复哈希计算的次数，增加计算时间以抵抗暴力攻击</li>
                        <li><strong>密钥长度</strong>：派生密钥的长度（字节）</li>
                        <li><strong>哈希函数</strong>：用于哈希计算的伪随机函数</li>
                    </ul>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h5>生成盐值</h5>
                        <form id="saltForm">
                            <div class="mb-3">
                                <label for="saltLength" class="form-label">盐值长度（字节）</label>
                                <select class="form-select" id="saltLength">
                                    <option value="16" selected>16</option>
                                    <option value="24">24</option>
                                    <option value="32">32</option>
                                </select>
                            </div>
                            <button type="button" id="generateSaltBtn" class="btn btn-secondary">
                                <i class="fas fa-random me-1"></i> 生成盐值
                            </button>
                        </form>
                        <div class="result-area mt-3" id="saltResult" style="display:none;"></div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <h5>密钥派生</h5>
                        <form id="pbkdf2Form">
                            <div class="mb-3">
                                <label for="pbkdf2Password" class="form-label">密码</label>
                                <input type="password" class="form-control" id="pbkdf2Password" placeholder="输入密码">
                            </div>
                            <div class="mb-3">
                                <label for="pbkdf2Salt" class="form-label">盐值（十六进制）</label>
                                <input type="text" class="form-control" id="pbkdf2Salt" placeholder="输入十六进制盐值">
                            </div>
                            <div class="mb-3">
                                <label for="pbkdf2Iterations" class="form-label">迭代次数</label>
                                <select class="form-select" id="pbkdf2Iterations">
                                    <option value="1000">1,000</option>
                                    <option value="5000">5,000</option>
                                    <option value="10000" selected>10,000</option>
                                    <option value="25000">25,000</option>
                                    <option value="50000">50,000</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="pbkdf2DkLen" class="form-label">密钥长度（字节）</label>
                                <select class="form-select" id="pbkdf2DkLen">
                                    <option value="16">16 (128 bits)</option>
                                    <option value="24">24 (192 bits)</option>
                                    <option value="32" selected>32 (256 bits)</option>
                                    <option value="64">64 (512 bits)</option>
                                </select>
                            </div>
                            <button type="button" id="derivePbkdf2KeyBtn" class="btn btn-danger">
                                <i class="fas fa-key me-1"></i> 派生密钥
                            </button>
                        </form>
                        <div class="result-area mt-3" id="pbkdf2Result" style="display:none;"></div>
                    </div>
                    
                    <div class="col-md-6">
                        <h5>密钥验证</h5>
                        <form id="pbkdf2VerifyForm">
                            <div class="mb-3">
                                <label for="pbkdf2VerifyPassword" class="form-label">密码</label>
                                <input type="password" class="form-control" id="pbkdf2VerifyPassword" placeholder="输入密码">
                            </div>
                            <div class="mb-3">
                                <label for="pbkdf2VerifyDerivedKey" class="form-label">派生密钥（十六进制）</label>
                                <input type="text" class="form-control" id="pbkdf2VerifyDerivedKey" placeholder="输入十六进制派生密钥">
                            </div>
                            <div class="mb-3">
                                <label for="pbkdf2VerifySalt" class="form-label">盐值（十六进制）</label>
                                <input type="text" class="form-control" id="pbkdf2VerifySalt" placeholder="输入十六进制盐值">
                            </div>
                            <div class="mb-3">
                                <label for="pbkdf2VerifyIterations" class="form-label">迭代次数</label>
                                <select class="form-select" id="pbkdf2VerifyIterations">
                                    <option value="1000">1,000</option>
                                    <option value="5000">5,000</option>
                                    <option value="10000" selected>10,000</option>
                                    <option value="25000">25,000</option>
                                    <option value="50000">50,000</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="pbkdf2VerifyDkLen" class="form-label">密钥长度（字节）</label>
                                <select class="form-select" id="pbkdf2VerifyDkLen">
                                    <option value="16">16 (128 bits)</option>
                                    <option value="24">24 (192 bits)</option>
                                    <option value="32" selected>32 (256 bits)</option>
                                    <option value="64">64 (512 bits)</option>
                                </select>
                            </div>
                            <button type="button" id="verifyPbkdf2KeyBtn" class="btn btn-outline-danger">
                                <i class="fas fa-check-circle me-1"></i> 验证密钥
                            </button>
                        </form>
                        <div class="result-area mt-3" id="pbkdf2VerifyResult" style="display:none;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // 基本哈希函数
    $('#calculateHashBtn').click(function() {
        const message = $('#hashMessage').val();
        const algorithm = $('#hashAlgorithm').val();
        const button = this;
        const originalText = $(button).html();
        
        if (!message) {
            showResult('#hashResult', '消息不能为空', false);
            return;
        }
        
        showLoading(button);
        
        let endpoint = '';
        switch (algorithm) {
            case 'sha1':
                endpoint = '/api/hash/sha1';
                break;
            case 'sha256':
                endpoint = '/api/hash/sha256';
                break;
            case 'sha3_256':
                endpoint = '/api/hash/sha3-256';
                break;
            case 'sha3_512':
                endpoint = '/api/hash/sha3-512';
                break;
            case 'ripemd160':
                endpoint = '/api/hash/ripemd160';
                break;
            default:
                endpoint = '/api/hash/sha256';
        }
        
        $.ajax({
            url: endpoint,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ message: message }),
            success: function(response) {
                if (response.success) {
                    showResult('#hashResult', response.data.hash);
                } else {
                    showResult('#hashResult', response.message, false);
                }
                hideLoading(button, originalText);
            },
            error: function(xhr, status, error) {
                showResult('#hashResult', handleAjaxError(xhr, status, error), false);
                hideLoading(button, originalText);
            }
        });
    });
    
    // 生成随机HMAC密钥
    $('#generateHmacKey').click(function() {
        const randomKey = generateRandomString(16);
        $('#hmacKey').val(randomKey);
    });
    
    // HMAC计算
    $('#calculateHmacBtn').click(function() {
        const message = $('#hmacMessage').val();
        const key = $('#hmacKey').val();
        const algorithm = $('#hmacAlgorithm').val();
        const button = this;
        const originalText = $(button).html();
        
        if (!message || !key) {
            showResult('#hmacResult', '消息和密钥不能为空', false);
            return;
        }
        
        showLoading(button);
        
        let endpoint = '';
        switch (algorithm) {
            case 'hmac_sha1':
                endpoint = '/api/hash/hmac-sha1';
                break;
            case 'hmac_sha256':
                endpoint = '/api/hash/hmac-sha256';
                break;
            default:
                endpoint = '/api/hash/hmac-sha256';
        }
        
        $.ajax({
            url: endpoint,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ message: message, key: key }),
            success: function(response) {
                if (response.success) {
                    showResult('#hmacResult', response.data.hmac);
                } else {
                    showResult('#hmacResult', response.message, false);
                }
                hideLoading(button, originalText);
            },
            error: function(xhr, status, error) {
                showResult('#hmacResult', handleAjaxError(xhr, status, error), false);
                hideLoading(button, originalText);
            }
        });
    });
    
    // 生成盐值
    $('#generateSaltBtn').click(function() {
        const length = $('#saltLength').val();
        const button = this;
        const originalText = $(button).html();
        
        showLoading(button);
        
        $.ajax({
            url: '/api/hash/generate-salt',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ length: parseInt(length) }),
            success: function(response) {
                if (response.success) {
                    showResult('#saltResult', response.data.salt);
                    
                    // 自动填充表单
                    $('#pbkdf2Salt').val(response.data.salt);
                    $('#pbkdf2VerifySalt').val(response.data.salt);
                } else {
                    showResult('#saltResult', response.message, false);
                }
                hideLoading(button, originalText);
            },
            error: function(xhr, status, error) {
                showResult('#saltResult', handleAjaxError(xhr, status, error), false);
                hideLoading(button, originalText);
            }
        });
    });
    
    // PBKDF2派生密钥
    $('#derivePbkdf2KeyBtn').click(function() {
        const password = $('#pbkdf2Password').val();
        const salt = $('#pbkdf2Salt').val();
        const iterations = $('#pbkdf2Iterations').val();
        const dklen = $('#pbkdf2DkLen').val();
        const button = this;
        const originalText = $(button).html();
        
        if (!password || !salt) {
            showResult('#pbkdf2Result', '密码和盐值不能为空', false);
            return;
        }
        
        showLoading(button);
        
        $.ajax({
            url: '/api/hash/pbkdf2',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ 
                password: password,
                salt: salt,
                iterations: parseInt(iterations),
                dklen: parseInt(dklen)
            }),
            success: function(response) {
                if (response.success) {
                    showResult('#pbkdf2Result', response.data.derived_key);
                    
                    // 自动填充验证表单
                    $('#pbkdf2VerifyPassword').val(password);
                    $('#pbkdf2VerifyDerivedKey').val(response.data.derived_key);
                    $('#pbkdf2VerifySalt').val(salt);
                    $('#pbkdf2VerifyIterations').val(iterations);
                    $('#pbkdf2VerifyDkLen').val(dklen);
                } else {
                    showResult('#pbkdf2Result', response.message, false);
                }
                hideLoading(button, originalText);
            },
            error: function(xhr, status, error) {
                showResult('#pbkdf2Result', handleAjaxError(xhr, status, error), false);
                hideLoading(button, originalText);
            }
        });
    });
    
    // PBKDF2验证密钥
    $('#verifyPbkdf2KeyBtn').click(function() {
        const password = $('#pbkdf2VerifyPassword').val();
        const derivedKey = $('#pbkdf2VerifyDerivedKey').val();
        const salt = $('#pbkdf2VerifySalt').val();
        const iterations = $('#pbkdf2VerifyIterations').val();
        const dklen = $('#pbkdf2VerifyDkLen').val();
        const button = this;
        const originalText = $(button).html();
        
        if (!password || !derivedKey || !salt) {
            showResult('#pbkdf2VerifyResult', '密码、派生密钥和盐值不能为空', false);
            return;
        }
        
        showLoading(button);
        
        $.ajax({
            url: '/api/hash/pbkdf2-verify',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ 
                password: password,
                derived_key: derivedKey,
                salt: salt,
                iterations: parseInt(iterations),
                dklen: parseInt(dklen)
            }),
            success: function(response) {
                if (response.success) {
                    const verified = response.data.verified;
                    const resultText = verified ? '验证成功：密钥匹配' : '验证失败：密钥不匹配';
                    showResult('#pbkdf2VerifyResult', resultText, verified);
                } else {
                    showResult('#pbkdf2VerifyResult', response.message, false);
                }
                hideLoading(button, originalText);
            },
            error: function(xhr, status, error) {
                showResult('#pbkdf2VerifyResult', handleAjaxError(xhr, status, error), false);
                hideLoading(button, originalText);
            }
        });
    });
});
</script>
{% endblock %} 